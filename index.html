<!DOCTYPE html>
<html>
<head>
    <title>Reading</title>

    <meta charset="utf-8" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type="text/css">
    </style>
</head>

<body>
  <div id="editor">
    <input type="text" id="title" name="title" placeholder="Title"><br>
    <input type="source" id="source" name="source" placeholder="Source"><br>
    <textarea id="text" name="text" rows="30" cols="120"></textarea> <br>
    <button id="synthesize" onclick='synthesizeAudio()'>Synthesize</button>
    <button id="removeCitations" onclick='removeCitations()'>Remove Wiki-style Citations</button>
    <input type="text" id="wikipedia" name="wikipedia" placeholder="Wikipedia"><br>
    <button id="searchWiki" onclick='searchWiki()'>Search Wikipedia</button>
  </div>
  <hr>
  <div id="display">
    <div id="viewport">View</div>
    <span id="totalDuration">Total Duration</span>
    <span id="progress">0/0</span>
  </div>
  <hr>
  <div id="controls">
    <button id="playpause" onclick='playPauseAudio()'>Pause</button>
    <button id="restart" onclick='restartAudio()'>Restart</button>
    <input type="range" id="speed" name="speed" min="0.5" max="2.0" step="0.1" value="1.0" oninput="setAudioSpeed(this.value)">
    <span id="speedValue">1.0</span>
    <input type="number" id="currentIdx" name="currentIdx" placeholder="Current Index">
    <button id="prev" onclick='prevAudio()'>Prev</button>
    <button id="next" onclick='nextAudio()'>Next</button>
  </div>
</body>
<script>
  var shas = [];
  var currentIndex = 0;
  var currentAudio = null;
  var currentSpeed = 1.0;
  var sessionID = null;

  function searchWiki() {
    var wikipedia = document.getElementById('wikipedia').value;
    console.log(wikipedia);
    fetch('/wikipedia', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({title: wikipedia})
    }).then(function(response) {
      return response.json();
    }).then(function(data) {
      console.log(data);

      var title = data['title'];
      var url = data['url'];
      var content = data['content'];

      document.getElementById('title').value = title;
      document.getElementById('source').value = url;
      document.getElementById('text').value = content;
    });
  }

  function nextAudio() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.remove();
    }
    currentIndex++;
    if (currentIndex < shas.length) {
      playAudioSequence();
    }
  }

  function prevAudio() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.remove();
    }
    currentIndex--;
    if (currentIndex >= 0) {
      playAudioSequence();
    }
  }

  function playPauseAudio() {
    if (currentAudio) {
      if (currentAudio.paused) {
        currentAudio.play();
        document.getElementById('playpause').innerText = "Pause";
      } else {
        currentAudio.pause();
        document.getElementById('playpause').innerText = "Play";
      }
    }
  }

  function restartAudio() {
    currentIndex = 0;
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.remove();
    }
    playAudioSequence();
  }

  function setAudioSpeed(speed) {
    document.getElementById('speedValue').innerText = speed;
    currentSpeed = speed;
    if (currentAudio) {
      currentAudio.playbackRate = speed;
    }
  }

  function playAudioSequence() {
    var text = "data/text-"+shas[currentIndex]+".txt";
    fetch(text).then(function(response) {
      return response.text();
    }).then(function(data) {
      document.getElementById('viewport').innerText = data;
    });

    document.getElementById('progress').innerText = (currentIndex+1) + "/" + shas.length;
    var audio = new Audio("data/output-"+shas[currentIndex]+".mp3");
    audio.play();
    audio.playbackRate = currentSpeed;
    currentAudio = audio;
    audio.onloadedmetadata = function() {
      console.log("Playing audio of duration " + audio.duration + " seconds");
    };

    audio.onended = function() {
      audio.remove();
      currentIndex++;
      if (currentIndex < shas.length) {
        playAudioSequence();
      }
    };
  }

  function synthesizeAudio() {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio.remove();
    }

    var text = document.getElementById('text').value;
    fetch('/synthesize', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({text: text})
    }).then(function(response) {
      return response.json();
    }).then(function(data) {
      console.log(data);
      shas = data['shas'];
      sessionID = data['sessionID'];
      currentIndex = 0;

      playAudioSequence();
    });
  }
</script>
</html>
